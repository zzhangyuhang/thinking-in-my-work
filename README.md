# 实习工作中的对一些问题的思考
# 思考包括
## 1.数据仓库的学习和了解
## 2.业务中需要的问题和思考
## 3.技术的应用(学习过程不详细记录了)
### 备注:日记形式记录 


## 3.15,商品ctr的排序问题
### 工作内容
* 制作一张关于全新商品的ctr报表
* 需要内容:商品ID,商品名,sku,展示次数,展示人数,点击次数,点击人数,ctr-pv,ctr-uv
* 按照ctr转化率排序给出TOP200
* pass掉展示次数小于1000的
* 按照天为单位

### 内容解读
* ctr就是展示到点击的转化率,ctr = 点击数/展示数
* ctr能够体现出一款商品的吸引力.
* 报表制作过程没有什么问题,有相关数据统计,直接统计数据请求次数就ok了.
	* 之前ctr采用的请求接口数量,但是这样存在很大的误差.有时候甚至点击量比展示量还要多
	* 现在给展示以及点击都加了数据埋点,而且埋点的规则很严格,基本上误差可以限制在很小

### 关于ctr排序问题的思考
* 开始接到这个需求的时候,是按照ctr转化率来排序的,这很正常.
* 后来修改为按照展示人数排序.
* 按照ctr/展示人数排序的区别
	* 哪一款商品有热度有吸引力(ctr转化率高)
	* 但是容易受到商品其他因素的影响,例如商品封面的吸引力,商品价格等等
* 后来经过商量改为按照展示数uv来进行排序.为什么?
	* 以实习生出数据角度,无非是看个当前热度比较高的商品罢了.但是既然要出这个报表就说明这排名是由可挖掘的东西存在的,仔细想一想有什么东西可以从ctr排名中得出呢?
	* 显然我们只能看到热度商品的热度而已,影响因素一个也看不到.
	* 如果以展示uv来排序的话,某一款商品存在问题就一目了然.因为展示人数多,被很多人看到,但是ctr转化率很低一下子就说明出商品本身存在问题.然后我们锁了商品,去找原因.比如没有细节图或者细节图更少;售价高让人望而却步;封面丑没有点进去的欲望.
	* 可能你也会想到按照ctr排序,排序低的不也能看到吗?其实不然,ctr排序低的商品不一定存在问题,因为可能存在流量问题,也就是说没有获得更多的曝光.得到曝光缺不吸引人的商品是不是问题更大呢?
	
* 那么,按照ctr排序就不好吗?
	* 不是的,要根据实际业务需求来确定.
	* 当你们要搞活动大促销的时候,希望知道哪些商品热度高来参加活动.或者我们想给一些虽然ctr低,但是有实质的商品更多的曝光的时候,按照ctr排序更好
	* 如果要挖掘当前曝光产品问题就需要按照曝光人数排序.

## 3.19,按直播场次为单位完美转化成天为单位统计数据
### 工作内容
* 日常需求,统计主播数据(直播天数,直播时长,累计直播收益)
* 数据基础有个dw层的微聚合表,以直播场次为单位记录该场次相关的数据(主播信息:id/name/ip/位置,直播状态,设备信息:app版本/os/os版本/设备类型/,开始时间,结束时间,直播时长,累计观众数,最大在线观看数,观看时长,点赞次数,分享次数:站内/站外,评论数,评论人数,新增粉丝数,收益数,送礼人数).
* 数据需求:2月份整月收益流水达5000之上的主播相关信息.

### 内容解读
* 可以从dw层的直播相关表中就能直接获取大量的数据.
* 根据直播时间来筛选出在2月份的开播记录,按照主播分组,sum(直播时长),sum(收益)
* 注意筛选的时候,那种跨天级的直播要如何处理?最开始做需求的时候,采用的是start_time为标准,该场直播就划分在start_date中,不考虑跨天级别.数据也好处理.但是这种方式在记录主播开播天数存在的问题比较大.以及以往直播相关的需求也基本上都是按照天数为单位来统计的,如何才能减小误差呢?

### 关于跨天级的直播处理

1. 从底层ods表再以天为单位抽象出一个天为单位的表来,忽略直播场次.
	* 这种方法在计算收益以/观众数uv/分享次数uv等等还是可以的.以这些记录的add_time来划分每一天,然后根据主播来分组,直接忽略掉直播ID这个中间单位.但是在计算观看时长,以及本次这种按月统计天数就显得力不从心,因为底层数据未免有些太大了.
	* 而且统计的误差场次也就是那种跨天的直播场次,没跨天的直播没有任何影响,未免有些小题大做.
	* 如果需求是就要知道当天看过该主播直播的uv,或者分享的uv,那没有办法,就需要从底层ods层取细粒度数据统计.如果是上述的需求按月份统计直播天数就不太好.

2. 在场的基础表上抽象出天的直播
	* 目标是跨天的直播(造成误差的也是跨天的直播),不意味改整体表结构,需要处理的是开始时间和结束时间. 
	* 需要将跨天的直播拆成两个直播.

```sql
	select lid,start_date as live_date --正常不跨天的直播,start_date = end_date
	from live_table 
	where start_date = end_date
	
	union all
	
	select lid,start_date as live_date --跨天的直播,取开始天部分的直播
	from live_table
	where start_date != end_date
	
	union all
	
	select lid,end_date as live_date --不要忘了还要去结束天部分的直播
	from live_table
	where start_date != end_date
	 
```

* 这样虽然dw层是场次为单位的记录方式,但是也被我们拆成天数来看待,然后我们用live-date来做数据统计就ok啦.

### 问题解决
* 知道如何将按场次统计转化为按天统计,那么我们上面遇到的需求该怎么做呢?
1. 要筛选出2月份的直播,考虑跨天问题
	* 起始时间不在2月,结束时间在2月.
	* 起始时间在2月,结束时间超出2月.
	* 其实,也就是只要开始时间或者结束时间有一个是在2月份的直播.

```sql

	select lid,... --筛选出的基础表
	from live_table
	where (start_date between 20190201 and 20190228)
	  or  (end_date between 20190201 and 20190228)
```

2. 以上述基础表来划分天来统计
	* 不跨天的,正常统计开始时间即可.
	* 跨天的需要按照天拆分,拆分方式如上

3. 按照主播为单位分组,count(distinct live_date).
